name: build-release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  win-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build exe
        run: |
          pyinstaller --onefile --name revart_scoreboard_decoder_win --windowed revart_timing_decoder_gui.py
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: win
          path: dist/*

  linux-build:
    runs-on: ubuntu-22.04
    container:
      image: quay.io/pypa/manylinux2014_x86_64

    steps:
      - uses: actions/checkout@v4

      # Tkinter runtime bits inside the build container so PyInstaller can see them
      - name: Install system deps (Tk)
        run: |
          yum -y install tcl tk
          yum clean all

      - name: Install Python deps
        run: |
          /opt/python/cp311-cp311/bin/python -m pip install --upgrade pip
          /opt/python/cp311-cp311/bin/pip install -r requirements.txt
          /opt/python/cp311-cp311/bin/pip install pyinstaller

      # Build in onedir mode for AppImage bundling
      - name: Build (PyInstaller onedir)
        run: |
          /opt/python/cp311-cp311/bin/pyinstaller --noconfirm --onedir --name revart_scoreboard_decoder rhs.py
          ls -la dist
          ls -la dist/revart_scoreboard_decoder

      # Create AppDir structure + desktop file + icon (minimal placeholder icon)
      - name: Prepare AppDir
        run: |
          set -eux
          APP=revart_scoreboard_decoder
          APPDIR=AppDir

          rm -rf "$APPDIR"
          mkdir -p "$APPDIR/usr/bin"

          # Copy the whole onedir bundle
          cp -a "dist/$APP/." "$APPDIR/usr/bin/"

          # Desktop file
          cat > "$APPDIR/$APP.desktop" << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=Revart Scoreboard Decoder
          Exec=revart_scoreboard_decoder
          Icon=revart_scoreboard_decoder
          Categories=Utility;
          Terminal=false
          EOF

          # Tiny placeholder icon (1x1 PNG). Replace later with your real icon if you want.
          python3 - << 'PY'
          import base64, pathlib
          data = base64.b64decode(
            "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO0p1mUAAAAASUVORK5CYII="
          )
          pathlib.Path("AppDir/revart_scoreboard_decoder.png").write_bytes(data)
          PY

          # Make sure main executable is executable
          chmod +x "$APPDIR/usr/bin/$APP"

      # Build the AppImage using linuxdeploy + plugin
      # We extract AppImages to avoid needing FUSE inside the container.
      - name: Build AppImage
        run: |
          set -eux
          curl -L -o linuxdeploy.AppImage https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          curl -L -o linuxdeploy-plugin-appimage.AppImage https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage
          chmod +x linuxdeploy.AppImage linuxdeploy-plugin-appimage.AppImage

          ./linuxdeploy.AppImage --appimage-extract
          ./linuxdeploy-plugin-appimage.AppImage --appimage-extract

          export PATH="$PWD/squashfs-root/usr/bin:$PATH"
          export LINUXDEPLOY_PLUGINS_DIR="$PWD/squashfs-root/usr/bin"
          export ARCH=x86_64

          linuxdeploy \
            --appdir AppDir \
            --desktop-file AppDir/revart_scoreboard_decoder.desktop \
            --icon-file AppDir/revart_scoreboard_decoder.png \
            --output appimage

          ls -la ./*.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: ./*.AppImage


  release:
    needs: [win-build, linux-build]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Show assets
        run: |
          find release_assets -type f -maxdepth 3 -print

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/**/*
