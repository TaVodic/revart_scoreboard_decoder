name: build-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  win-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build exe
        run: |
          pyinstaller --onefile --name revart_scoreboard_decoder_win --windowed rhs.py
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: win
          path: dist/*

  linux-build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Build (manylinux2014, PyInstaller onedir -> AppDir) + GLIBC check
        shell: bash
        run: |
          set -eux

          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "$PWD":/src \
            -w /src \
            quay.io/pypa/manylinux2014_x86_64 \
            bash -lc '
              set -eux

              # clean to avoid accidentally reusing anything built on ubuntu-22.04
              rm -rf build dist AppDir *.spec

              yum -y install tcl tk
              yum clean all

              /opt/python/cp311-cp311/bin/python -m pip install --upgrade pip
              /opt/python/cp311-cp311/bin/pip install -r requirements.txt
              /opt/python/cp311-cp311/bin/pip install pyinstaller

              /opt/python/cp311-cp311/bin/pyinstaller --noconfirm --onedir --name revart_scoreboard_decoder rhs.py

              rm -rf AppDir
              mkdir -p AppDir/usr/bin
              cp -a dist/revart_scoreboard_decoder/. AppDir/usr/bin/

              cat > AppDir/revart_scoreboard_decoder.desktop << "EOF"
              [Desktop Entry]
              Type=Application
              Name=Revart Scoreboard Decoder
              Exec=revart_scoreboard_decoder
              Icon=revart_scoreboard_decoder
              Categories=Utility;
              Terminal=false
              EOF

              python3 - << "PY"
              import struct, zlib
              w = h = 64
              sig = b"\x89PNG\r\n\x1a\n"
              ihdr_data = struct.pack(">IIBBBBB", w, h, 8, 6, 0, 0, 0)
              ihdr = b"IHDR" + ihdr_data
              ihdr_crc = struct.pack(">I", zlib.crc32(ihdr) & 0xFFFFFFFF)
              ihdr_chunk = struct.pack(">I", len(ihdr_data)) + ihdr + ihdr_crc
              row = b"\x00" + (b"\x00\x00\x00\x00" * w)
              raw = row * h
              compressed = zlib.compress(raw, 9)
              idat = b"IDAT" + compressed
              idat_crc = struct.pack(">I", zlib.crc32(idat) & 0xFFFFFFFF)
              idat_chunk = struct.pack(">I", len(compressed)) + idat + idat_crc
              iend = b"IEND"
              iend_crc = struct.pack(">I", zlib.crc32(iend) & 0xFFFFFFFF)
              iend_chunk = struct.pack(">I", 0) + iend + iend_crc
              with open("AppDir/revart_scoreboard_decoder.png", "wb") as f:
                f.write(sig + ihdr_chunk + idat_chunk + iend_chunk)
              PY

              chmod +x AppDir/usr/bin/revart_scoreboard_decoder

              echo "=== GLIBC required by bundled libpython (should be <= 2.23 for Ubuntu 16.04) ==="
              strings AppDir/usr/bin/_internal/libpython3.11.so.1.0 \
                | grep -o "GLIBC_[0-9]\+\.[0-9]\+" \
                | sort -V \
                | tail -n 10
            '

      - name: Build AppImage (on runner)
        run: |
          set -eux
          curl -L -o linuxdeploy.AppImage https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          curl -L -o linuxdeploy-plugin-appimage.AppImage https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage
          chmod +x linuxdeploy.AppImage linuxdeploy-plugin-appimage.AppImage

          ./linuxdeploy.AppImage --appimage-extract
          ./linuxdeploy-plugin-appimage.AppImage --appimage-extract

          export PATH="$PWD/squashfs-root/usr/bin:$PATH"
          export ARCH=x86_64

          linuxdeploy \
            --appdir AppDir \
            --desktop-file AppDir/revart_scoreboard_decoder.desktop \
            --icon-file AppDir/revart_scoreboard_decoder.png \
            --output appimage

          ls -la ./*.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: ./*.AppImage

  release:
    needs: [win-build, linux-build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag for release
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            git fetch --tags --force
            TAG="$(git describe --tags --abbrev=0)"
            if [[ -z "${TAG}" ]]; then
              echo "No tags found. Cannot publish a GitHub Release without a tag."
              exit 1
            fi
            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          fi
          echo "Using tag: $(cat $GITHUB_OUTPUT | sed -n 's/^tag=//p')"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Show assets
        run: |
          find release_assets -type f -maxdepth 3 -print

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: release_assets/**/*

