name: build-release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  win-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build exe
        run: |
          pyinstaller --onefile --name revart_scoreboard_decoder_win --windowed rhs.py
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: win
          path: dist/*

  linux-build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Build in manylinux (PyInstaller onedir -> AppDir)
        run: |
          docker run --rm \
            -v "$PWD":/src \
            -w /src \
            quay.io/pypa/manylinux2014_x86_64 \
            bash -lc '
              set -eux

              yum -y install tcl tk
              yum clean all

              /opt/python/cp311-cp311/bin/python -m pip install --upgrade pip
              /opt/python/cp311-cp311/bin/pip install -r requirements.txt
              /opt/python/cp311-cp311/bin/pip install pyinstaller

              /opt/python/cp311-cp311/bin/pyinstaller --noconfirm --onedir --name revart_scoreboard_decoder rhs.py

              rm -rf AppDir
              mkdir -p AppDir/usr/bin
              cp -a dist/revart_scoreboard_decoder/. AppDir/usr/bin/

              cat > AppDir/revart_scoreboard_decoder.desktop << "EOF"
              [Desktop Entry]
              Type=Application
              Name=Revart Scoreboard Decoder
              Exec=revart_scoreboard_decoder
              Icon=revart_scoreboard_decoder
              Categories=Utility;
              Terminal=false
              EOF

              python3 - << "PY"
              import base64, pathlib
              data = base64.b64decode("iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO0p1mUAAAAASUVORK5CYII=")
              pathlib.Path("AppDir/revart_scoreboard_decoder.png").write_bytes(data)
              PY

              chmod +x AppDir/usr/bin/revart_scoreboard_decoder
            '

      - name: Build AppImage (on runner)
        run: |
          set -eux
          curl -L -o linuxdeploy.AppImage https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          curl -L -o linuxdeploy-plugin-appimage.AppImage https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage
          chmod +x linuxdeploy.AppImage linuxdeploy-plugin-appimage.AppImage

          # extract to avoid FUSE dependency
          ./linuxdeploy.AppImage --appimage-extract
          ./linuxdeploy-plugin-appimage.AppImage --appimage-extract

          export PATH="$PWD/squashfs-root/usr/bin:$PATH"
          export ARCH=x86_64

          linuxdeploy \
            --appdir AppDir \
            --desktop-file AppDir/revart_scoreboard_decoder.desktop \
            --icon-file AppDir/revart_scoreboard_decoder.png \
            --output appimage

          ls -la ./*.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: ./*.AppImage



  release:
    needs: [win-build, linux-build]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Show assets
        run: |
          find release_assets -type f -maxdepth 3 -print

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/**/*
